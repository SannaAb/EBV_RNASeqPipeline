#!/bin/bash -l

#SBATCH -A sens2018120
#SBATCH -p core
#SBATCH -n 1
#SBATCH -t 1:00:00
#SBATCH -J Bench


module load bioinfo-tools
module load subread/2.0.0
module load samtools/1.8
#module load conda
module load biopython/1.73


FirstAnno=/proj/sens2018120/nobackup/wharf/sannaa/sannaa-sens2018120/db/Annotation/NC_007605.1-20210315_NC_changedfornon-strandedsequencing.tsv
#FirstAnno=/proj/sens2018120/nobackup/wharf/sannaa/sannaa-sens2018120/db/Annotation/NC_007605.1-20210315_NC_changedforstrandedsequencing.tsv
SecondAnno=/proj/sens2018120/nobackup/wharf/sannaa/sannaa-sens2018120/db/Annotation/NC_007605.1-20210304_RPMS1unassigned.tsv


mkdir -p NewCounts

inname=$1


echo "

featureCounts -a $FirstAnno -M -s 0 -J -p -t exon --Rpath NewCounts/ -R BAM -g gene -o NewCounts/$1.counts EBV_Alignment/$1_KeptEBER.3Missmatch_40nt_10Multimapped.EBV.bam

"

featureCounts -a $FirstAnno -M -s 0 -J -p -t exon --Rpath NewCounts/ -R BAM -g gene -o NewCounts/$1.counts EBV_Alignment/$1_KeptEBER.3Missmatch_40nt_10Multimapped.EBV.bam


echo "

samtools view NewCounts/$1_KeptEBER.3Missmatch_40nt_10Multimapped.EBV.bam.featureCounts.bam -h | grep -e "^@" -e Unassigned_NoFeatures  | samtools view -Sb - > NewCounts/$1_unassigned.bam

"

samtools view NewCounts/$1_KeptEBER.3Missmatch_40nt_10Multimapped.EBV.bam.featureCounts.bam -h | grep -e "^@" -e Unassigned_NoFeatures  | samtools view -Sb - > NewCounts/$1_unassigned.bam

echo "

samtools sort NewCounts/$1_unassigned.bam -o NewCounts/$1_unassigned_sorted.bam

"

samtools sort NewCounts/$1_unassigned.bam -o NewCounts/$1_unassigned_sorted.bam

echo "

samtools index NewCounts/$1_unassigned_sorted.bam

"

samtools index NewCounts/$1_unassigned_sorted.bam


echo "

featureCounts -a $SecondAnno -M -s 0 -J -p -t exon -g gene -o NewCounts/$1.Genecounts NewCounts/$1_unassigned_sorted.bam

"

featureCounts -a $SecondAnno -M -s 0 -J -p -t exon -g gene -o NewCounts/$1.Genecounts NewCounts/$1_unassigned_sorted.bam

echo "

python /proj/sens2018120/nobackup/wharf/sannaa/sannaa-sens2018120/Scripts/MergeCountsFromTwoFeatureCountsRuns.py NewCounts/$1.counts NewCounts/$1.Genecounts

"


python /proj/sens2018120/nobackup/wharf/sannaa/sannaa-sens2018120/Scripts/MergeCountsFromTwoFeatureCountsRuns.py NewCounts/$1.counts NewCounts/$1.Genecounts

echo "

cat NewCounts/$1_Merge_unassigned_FeatureCounts.txt Human_counts/$1_count > NewCounts/$1_HV.count

"

#cat NewCounts/$1_Merge_unassigned_FeatureCounts.txt Human_counts/$1_KeptEBER.FeatureCounts_Human.txt > NewCounts/$1_HV.count

cat NewCounts/$1_Merge_unassigned_FeatureCounts.txt Human_counts/$1_count_FeatureCounts > NewCounts/$1_HV.count

echo "Done"
